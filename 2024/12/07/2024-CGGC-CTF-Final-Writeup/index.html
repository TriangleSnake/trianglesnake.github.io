<!DOCTYPE html>
<html>
<head><!-- hexo injector head_begin start --><!-- Microsoft Clarity begins-->
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "nq90i0uzl9");
    </script>
    <!-- Microsoft Clarity ends-->
    <!-- Google tag (gtag.js) begins-->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-16453505124"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'AW-16453505124');
    </script>
    <!-- Google tag (gtag.js) ends-->
    <!-- hexo injector head_begin end -->
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
  <title>
    
    2024 CGGC CTF Final Writeup 丨
    

    typo
  </title>

  
  <link rel="shortcut icon" href="/icon.svg">
  

  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  
  <link id="theme" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.css">
  <script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/highlight.min.js"></script>
  

  <!-- 字体 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel="stylesheet">

  
<link rel="stylesheet" href="/css/root.css">

  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/post.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <header class="header">
  <section class="header-container">
    <a class="logo" href="/">TriangeSnake&#39;s Blog</a>
    <ul class="nav">
      
      <li><a href="/archives">archives</a></li>
      
      <li><a href="/about">about</a></li>
      
    </ul>
  </section>
</header>
  <main class="main">
    <article class="post">
  
  <div class="post-title">2024 CGGC CTF Final Writeup</div>
  <div class="post-meta">
    <div class="date">2024 十二月 7日</div>
    <div class="tags">
      
      <div class="tag-item">writeup</div>
      
      <div class="tag-item">CTF</div>
      
      <div class="tag-item">web</div>
      
      <div class="tag-item">misc</div>
      
    </div>
  </div>
  

  <main class="post-content"><p>這次幫國網中心的CGGC 網路守護者挑戰賽出題，總共出了兩題 medium ，分別是 <code>web</code> 的 <code>Converter</code> 和 <code>misc</code> 的 <code>cat flag</code></p>
<h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="Converter"><a href="#Converter" class="headerlink" title="Converter"></a>Converter</h2><p>這是一個編碼的網站，可以編碼和解碼 <code>base16</code> &#x2F; <code>base32</code> &#x2F; <code>base64</code> &#x2F; <code>base85</code> 等不同網站<br>後端是使用 <code>Flask</code> 寫的，為了防止 <code>SSTI</code> ，在 <code>render_template_string</code> 之前我把一些地方 <code>HTML encode</code> 了</p>
<p><code>encode</code> 時 <code>input</code> 會被 <code>HTML encode</code><br><code>decode</code> 時 <code>input</code> 和 <code>result</code> 都會被 <code>HTML encode</code></p>
<pre><code class="highlight python"><span class="keyword">return</span> render_template_string(
    RESULT_TEMPLATE.<span class="built_in">format</span>(
    input_data=data, <span class="comment"># 皆會被 HTMLencode</span>
    conversion_type=conversion_type,
    action=action,
    result=result <span class="comment"># 只有 decode 時會被 HTMLencode</span>
))</code></pre>

<p>因此，想要 SSTI 就只剩下把東西拿去 encode 之後變成怪怪的東西了，那什麼狀況下 encode 會跑出怪怪的東西呢？其實去查一下四種編碼應該就可以很快發現 base85 的 index table 有可以利用的東西（<code>&#123;</code> 和 <code>&#125;</code>），但這樣其實還是不夠的，因為如果想要構造出 <code>&#123;&#125;</code> 那 <code>input</code> 會需要傳入不存在的字元，偏偏 <code>URL encoding</code> 又只會解碼特定的 <code>binary data</code>。</p>
<p>那怎麼辦呢，其實在 <code>encoding</code> 的時候還有第二個可控的地方，那就是 <code>Accept-Charset</code> </p>
<pre><code class="highlight python">encoding = request.headers.get(<span class="string">&#x27;Accept-Charset&#x27;</span>,<span class="string">&#x27;utf-8&#x27;</span>)
<span class="keyword">for</span> i <span class="keyword">in</span> [<span class="string">&#x27;utf&#x27;</span>,<span class="string">&#x27;ascii&#x27;</span>,<span class="string">&#x27;latin&#x27;</span>,<span class="string">&#x27;windows&#x27;</span>,<span class="string">&#x27;cp&#x27;</span>]:
    <span class="keyword">if</span> i <span class="keyword">in</span> encoding:
        <span class="keyword">break</span>
<span class="keyword">else</span>:
    <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Unsupported encoding&quot;</span>&#125;), <span class="number">400</span></code></pre>

<p>後端會根據輸入的 <code>charset</code> 去將傳入的資料 <code>encode</code> (但是僅限比較常見系列的編碼)</p>
<pre><code class="highlight python"><span class="keyword">elif</span> conversion_type == <span class="string">&quot;base85&quot;</span>:
    result = base64.b85encode(data.encode(encoding)).decode(encoding)</code></pre>

<p>有了這兩個可控的地方，我們就可以找到幾種編碼方式，把不存在的編碼變成存在的字元當成輸入， <code>fuzz</code> 一下就可以找出有效的 <code>payload</code><br>我這邊是使用 <code>cp850</code> 去想辦法構造出 <code>&#123;&#123;config&#125;&#125;</code> ，最後找到 <code>qX%15rx%15▒Bà└│</code> 可以弄出 <code>aaa&#123;&#123;config&#125;&#125;1</code></p>
<p>最終 <code>payload</code> ：</p>
<pre><code class="highlight HTML">POST /api/convert HTTP/1.1
Accept-Charset: cp850

data=qX%15rx%15▒Bà└│&amp;conversion_type=base85&amp;action=encode</code></pre>
<p><img src="/2024/12/07/2024-CGGC-CTF-Final-Writeup/1.png"></p>
<blockquote>
<p>flag: <code>CGGC&#123;&#39;ÞÑ┐Õ▒àÕ▒àÞÑ┐ÞÑ┐Þ©óÞ¬Æµ£ì&#39;.encode(&#39;cp850&#39;).decode(&#39;utf-8&#39;)&#125;</code></p>
</blockquote>
<h3 id="後記"><a href="#後記" class="headerlink" title="後記"></a>後記</h3><p>我看到超多人交的 <code>flag</code> 是把中間那坨拿去 <code>decode</code> 變成 <code>CGGC&#123;西居居西西踢誒服&#125;</code> ，然後發現不會過又改成 <code>CGGC&#123;CGGCCTF&#125;</code> &#x2F; <code>CGGC&#123;cggcctf&#125;</code> 最後才交上面的，超級好笑我很抱歉抱歉ㄉ心</p>
<h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><h2 id="Cat-Flag"><a href="#Cat-Flag" class="headerlink" title="Cat Flag"></a>Cat Flag</h2><p>這題是給使用者一個 <code>powershell</code> ，將 <code>flag</code> 寫在圖片裡面，透過 <code>AES-CBC</code> 加密後放在資料夾裡面（我會給密碼），參賽者要想辦法用 <code>powershell</code> 偷出 <code>flag</code></p>
<p>未免也太簡單了對吧？所以我加了一些限制：</p>
<ol>
<li>不能連網，對外連線通通 <code>DROP</code> 掉</li>
<li>指令長度不能超過 512 個字元</li>
<li>輸出字元數量不能超過檔案本身大小</li>
<li>每個 <code>instancer</code> 只能輸入一行指令</li>
<li>每次重開 <code>instancer</code> 都會用不同密碼加密</li>
</ol>
<p>所以，想要弄出 flag 只剩下一條路了，那就是 <code>cat flag</code> </p>
<p>但要怎麼輸出呢？大家馬上聯想到的應該都會是 <code>Base64</code> ，但是其實 <code>base64</code> 會把資料變成大胖呆（原本8個一組的資料變成6個一組），所以比賽現場就會看到一堆人弄出來的圖片長這樣：<br><img src="/2024/12/07/2024-CGGC-CTF-Final-Writeup/2.png"></p>
<p>啊 <code>flag</code> 咧？在下面被切掉了</p>
<p>我預期的解法有兩種：</p>
<ol>
<li>用 <code>base64</code> 切片抓下來，因為有給密碼了，所以可以透過第一組的明文使用第二組的密碼反向加密回去再和第二組的下半身合併成完整的圖片（這邊是 CBC 的 block cipher 所以要注意不要切爛了會有 padding 的問題）</li>
<li>因為是限制 <code>char</code> 所以可以想辦法把每個 <code>byte</code> 轉成自訂的寬字節就可以一次輸出整個檔案了，但是他又有限制指令只能 <code>512 char</code> ，所以可以找一下有沒有什麼內建的編碼方式是可以涵蓋到大部分的組合，然後在自訂沒涵蓋到的編碼就可以了，我這邊是用一個古老的編碼 <code>X-Europa</code> 把檔案 print 出來</li>
</ol>
<p>編碼：</p>
<pre><code class="highlight powershell"><span class="variable">$bytes</span> = [<span class="type">System.IO.File</span>]::ReadAllBytes(<span class="string">&quot;cat.flag&quot;</span>);<span class="variable">$compressedStream</span> = <span class="built_in">New-Object</span> System.IO.MemoryStream;<span class="variable">$result</span>=<span class="string">&quot;&quot;</span>;<span class="variable">$encoding</span>=[<span class="type">System.Text.Encoding</span>]::GetEncoding(<span class="string">&quot;x-europa&quot;</span>);<span class="keyword">ForEach</span> (<span class="variable">$byte</span> <span class="keyword">in</span> <span class="variable">$bytes</span>)&#123;<span class="keyword">if</span> (<span class="variable">$byte</span> <span class="operator">-eq</span> <span class="number">0</span>)&#123;<span class="variable">$result</span>+=<span class="string">&quot;嗨&quot;</span>&#125;<span class="keyword">elseif</span>(<span class="variable">$byte</span> <span class="operator">-eq</span> <span class="number">127</span>)&#123;<span class="variable">$result</span>+=<span class="string">&quot;哈&quot;</span>&#125;<span class="keyword">else</span>&#123;<span class="variable">$result</span>+=<span class="variable">$encoding</span>.GetString(<span class="variable">$byte</span>)&#125;&#125;;<span class="variable">$result</span></code></pre>

<p>解碼：</p>
<pre><code class="highlight powershell">
<span class="variable">$encodedResult</span> = <span class="variable">$result</span>

<span class="variable">$encoding</span> = [<span class="type">System.Text.Encoding</span>]::GetEncoding(<span class="string">&quot;x-europa&quot;</span>)

<span class="variable">$decodedBytes</span> = <span class="built_in">New-Object</span> System.Collections.Generic.List[<span class="built_in">byte</span>]

<span class="variable">$i</span> = <span class="number">0</span>
<span class="keyword">while</span> (<span class="variable">$i</span> <span class="operator">-lt</span> <span class="variable">$encodedResult</span>.Length) &#123;
    <span class="keyword">if</span> (<span class="variable">$encodedResult</span>.Substring(<span class="variable">$i</span>, <span class="number">1</span>) <span class="operator">-eq</span> <span class="string">&quot;嗨&quot;</span>) &#123;
        <span class="variable">$decodedBytes</span>.Add(<span class="number">0</span>)
        <span class="variable">$i</span> += <span class="number">1</span>
    &#125;
    <span class="keyword">elseif</span> (<span class="variable">$encodedResult</span>.Substring(<span class="variable">$i</span>, <span class="number">1</span>) <span class="operator">-eq</span> <span class="string">&quot;哈&quot;</span>) &#123;
        <span class="variable">$decodedBytes</span>.Add(<span class="number">127</span>)
        <span class="variable">$i</span> += <span class="number">1</span>
    &#125; 
    <span class="keyword">else</span> &#123;
        <span class="variable">$char</span> = <span class="variable">$encodedResult</span>.Substring(<span class="variable">$i</span>, <span class="number">1</span>)
        <span class="variable">$byte</span> = <span class="variable">$encoding</span>.GetBytes(<span class="variable">$char</span>)[<span class="number">0</span>]
        <span class="variable">$decodedBytes</span>.Add(<span class="variable">$byte</span>)
        <span class="variable">$i</span> += <span class="number">1</span>
    &#125;
&#125;
[<span class="type">System.IO.File</span>]::WriteAllBytes(<span class="string">&quot;flag.enc&quot;</span>,<span class="variable">$decodedBytes</span>)
openssl enc <span class="literal">-d</span> <span class="literal">-aes-256-cbc</span> <span class="literal">-pbkdf2</span> <span class="operator">-in</span> flag.enc <span class="literal">-out</span> flag.jpg <span class="literal">-k</span> <span class="variable">$password</span></code></pre>

<p>弄出來的資料大概會長這樣：</p>
<pre><code class="highlight plaintext">Salted__◀¶8ήρêWΒ▲À§§Τ║ΞÓCΖ↕É3$Ôoο│Ϋ*á‼αύ,&#123;┘ÇÕyPUΪχZ\æUΰal!ë;ΞΈ&gt;♬΄8nÆsÂΰηUv0Z·HO¡λg◘│.~┘ώ↕òΥbQ▼ΖΉPÜΎüκχ┘ΎÄ:q─É└xνϊî/&#x27;ηΊ5ίïΐ?èΘQν&gt;γ0b*kςO6Dv└║Aïί&amp;t◙ºω$↕°δ΄§ΥäΤnΆ1ö♂CοJ▼♪;βJΥΧ(ä.óhώ═2ÅE%δÕ◙◙╝G^Ό!ψ♂M○J╚¿9ºYΥΠΟÍ\○TAlérνyΦβ*Äλz¡&#x27;Ξίê→ÍìΦöίς║7Ñ+_☼/v/Θàξ4GΣLάæS♬6+FρθΕÑRôsÓτδ/┘YØàÅ¿Νό Bωy→Ήχ4e&quot;χÅηαH哈θόψώvu8cçãvßή═PqΏ-‼ΗÂ─ϊΉ│↕τUEÊ║Ά9ώΗέΘDèe&amp;哈ÖÍιwφή◙pάεΕé&quot;╚ËP)9◙╝嗨áω▼0↓哈▲ί→SΔεTSòk£όÕΜÄΡ^┐L%♂oοÑΥüμñΤηòύΡút^ÀΓVRεδ↑ξΰ)Ü○═eN│Ú$b+$°ϊ3Ã¶▲Σçν┐IN♂õΨΈ7z←[:)éÁ8♪◙ºöQMΰν┘QsσΉ♪↑IρΜYΊº°üï·jr↓S&#x27;ε‼ηζς¡4Ø§ΈΟÅ-╝τÚσBΗ?BΙ/x←+Äa♬`g/ϋΟΤëK║]Êãω←ΏÀ£_¡αóÂΰÍ^α└zϋp╔Nï·øáâ2ΘËΌΛÀLL%tÕÓDλmI◘ΦÊ↑ξK-^ë+,\γÄrßP─óÊhη&quot;4♂♬ί:ρ&quot;Iã6jÑΔΌª┌§/[O]αüöΔÂ╚┐:0õ1♂ύBθοÀÑBghϋRsºÀ哈F&quot;▼◘îΜaί;q╔ΞώΧΡBÚ┌·F7哈ύφ哈 μø&lt;À΄)ªö─¿ÁΧτ╔ΦhρMnζΡØz◘cªÆΥêΕ&quot;à_FΣ]Τοπ.Λr♬┌ØΓ#♂έ║Xá¶Ή↔ÂΒώ8/fSV@υÍÕfΓ3ζΚE·όϊ1ãA+|&#x27;ËÑς↓hO┘h╚a&quot;|ïâ9Ά!èàdÉg═xΙóæeΪñήR#&lt;ñ4&#x27;4õUΈά→Ξα◘ù,äέ;?H│&#125;,π7aΒ◀η║χΏ\x◙e1ώÂÂ@Vΐx‼6ΛÅzφ&amp;ύÉâ○όeΑι&lt;─@¶ΐΊu+°ΟªεΝΞΑΙd=7öÅ═+ßÁ\îΙ|嗨f£ΛñùΨßWÂ=΄*·eO,΄άω@XΨC,ìñu΄t JÄ▲dîîóîωI.ρÑ¶æuùÍπGôΡαjìΗù↑õ=ώûΑêηTæ&#123;ÍNVroKüΆώg&lt;euÂΠα`ήξ↓Αkό♬+§ÔόxW▲Ά*ζΘΧΰãΌ╗Læ+ ┐ρü0΄mlϊ4┌Ι]υêαφb¿Οό│]:\ìιΛ y¶άΜ(HúÅY§◘#ÃΕφàS嗨Æù↓Ëê9Gώæ.▼NΖJχ╚Pαè┐@Á(£nÂeìº↓maq§Ν0nØûEÚÕh哈kDGaíυ↔ó@SmabΰκTL‼/Ξy`♀sΠ&#123;mΉKENeΒΏκΥΆ&lt;Γ¶!▶@╗┌MÀϋVv¿$i↕Í↑aUEΈx◀^οΌûP╚◀àMϊk@▲£çèAÄvzÆNæÇέλ9ω▲xt嗨ª└ΓnîAθάï#Ηè↕Ã |y╚έãΤόGjρt·ρø↓r↑Éκtåς1y=É♀1A΄ω=╝┐ΞΠN0éïζΜ◘π|F╔óüα╗ΈôΊ↑υZξΞ_3Ñ♀ξöΟæºψζΜ╚Ãææΰωå♀λΗÆ5nτ♪è5°¡ΨºvΪGΛΜώΒΣ1öΝq╝öôοψW4èaσΝDΤÓs┘o╔=│¶ÉΌ♂ϋcëάbάΔÍbνü┐Ι&amp;ΥTEυBΉϋ↔8ιîΡ═Í!ΆΔΌ+¶2öτ◙zΧΕ[&lt;→,ΆòcÄj-Óf£7Q▶N)ΗΜ&gt;92kκêΫ`↔tφβ┘JwìÇ^ÅX|Τ7~3ê4└Ϋz£ÅκysΏ Y▼ΞôuË\UΜOÄοΉIoíΖB/ZΦΙΝVqwFAXΣ|:╝?έ╝iBV$ΧΫαYn΄a↔ΙBÂ-$Ά▼ι═Mεμλ¶ Ψóύá┌νÓÔ┘▲0σ←R¶εFWω↑sψ?.â#δ§ί┌ΓΉay£%]ΣÁUΟtÖUζνξ/ÔyöC☼╚M▼=;Ι&quot;8─ÄUÖÑΫãΐ&gt;δ4ξή:ΣβºόΛΒ~║O↓Lΐύw&quot;χ♂-↓ÚnèωrÅí◘ΜÚíVtΰ(ΓZPΚiê9FήΟ°r─σ◀ί♬?¿ΓόhXEΈ,υm;</code></pre>

<p><img src="/2024/12/07/2024-CGGC-CTF-Final-Writeup/cat.jpg"></p>
<h3 id="後記-1"><a href="#後記-1" class="headerlink" title="後記"></a>後記</h3><p>這題是用 @chummy 的 <a target="_blank" rel="noopener" href="https://github.com/Jimmy01240397/CTF-Instancer">CTF Instancer</a> 架的，會依序動態開 100 個 port給大家連 instancer ，結果有某海狗直接狂戳 port 幫大家把 instancer 都關起來（我完全沒想到可以這樣玩QQ）</p>
<p><img src="/2024/12/07/2024-CGGC-CTF-Final-Writeup/4.png"></p>
<p>後來臨時加了驗證 <code>CTFd Token</code> 的機制，感謝賽博水電工 Chummy 現場幫 instancer 加新功能，然後兩個人在那邊寫爛扣<br><img src="/2024/12/07/2024-CGGC-CTF-Final-Writeup/5.png"></p>
</main>

</article>


<script src="/js/highlight.js"></script>

  </main>
  <footer class="footer">
  
  <span>Copyright © TriangleSnake</span>
  
</footer>
  
<script src="/js/theme.js"></script>

</body>

</html>